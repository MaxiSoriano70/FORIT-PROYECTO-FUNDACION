# Etapa 1: Construcci칩n del backend y del dominio
FROM node:22-slim AS builder

WORKDIR /app

# Copiamos archivos de dependencias
COPY package.json package-lock.json ./
COPY domain/package*.json ./domain/
COPY apps/backend/package*.json ./apps/backend/

# Instalamos dependencias del dominio y backend
RUN npm install --prefix ./domain
RUN npm install --prefix ./apps/backend

# Copiamos solo las carpetas necesarias para construir el backend y el dominio
COPY domain/ ./domain/
COPY apps/backend/ ./apps/backend/

# Compilamos TypeScript del dominio y backend
RUN npm run build --prefix ./domain
RUN npm run build --prefix ./apps/backend

# Debug: list the backend folder and dist to check build output during image build
RUN ls -la /app || true
RUN ls -la /app/domain || true
RUN ls -la /app/apps || true
RUN ls -la /app/apps/backend || true
RUN ls -la /app/apps/backend/dist || true

# Etapa 2: Imagen final mucho m치s liviana
FROM node:22-slim
WORKDIR /app

# Copiamos solo los archivos necesarios para producci칩n
COPY --from=builder /app/apps/backend/dist ./apps/backend/dist
COPY --from=builder /app/apps/backend/package*.json ./apps/backend/

# Instalamos solo dependencias de producci칩n
RUN npm ci --prefix ./apps/backend --production

ENV NODE_ENV=production
EXPOSE 8080

# Iniciar el backend
CMD ["node", "apps/backend/dist/index.js"]
